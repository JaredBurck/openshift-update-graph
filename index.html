<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>OpenShift Update Graph</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <style>
        html {
            position: relative;
            min-height: 100%;
        }
        body > .container-fluid {
            padding-top: 60px;
        }
        body {
            margin-bottom: 60px;
        }
        .footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60px;
            line-height: 60px;
            background-color: #f5f5f5;
        }
        .failure {
            position: absolute;
            top: calc(60px + 1rem);
            right: 2rem;
        }
    </style>

</head>

<body>

<nav class="navbar navbar-light bg-light fixed-top">
    <span class="navbar-brand">OpenShift Upgdate Graph</span>
    <form class="form-inline">
        <select id="streams" class="form-control"></select>
    </form>
</nav>

<main role="main">
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <div class="updates">
                    <div style="height: calc(100vh - 60px)" id="graph"></div>
                    <div style="display: none; position: absolute; top: 60px; right: 0; height: 5rem; width: 100%;" id="progress">
                        <div class="progress">
                            <div id="progress-bar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="footer">
    <div class="container-fluid">
        <span class="text-muted">Fork me: <a href="https://github.com/ctron/openshift-update-graph" target="_blank">ctron/openshift-update-graph</a></span>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<script type="text/javascript">

    const DEFAULT_STREAM = "stable-4.4";
    let network;

    function failure(msg) {
        console.log("Failure:", msg);

        let t = $('<div class="mt-3 failure alert alert-danger alert-dismissible fade show" role="alert">' +
                '<strong>Failure!</strong> <span class="msg"></span>' +
                '  <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n' +
                '    <span aria-hidden="true">&times;</span>\n' +
                '  </button>'+
                '</div>');

        t.find(".msg").text(msg);

        console.log(t);
        $("main").append(t);
        t.alert();
    }

    function update_data(nodes, edges) {

        if (network) {
            network.destroy()
        }
        let container = document.getElementById('graph');
        let data = {
            nodes: nodes,
            edges: edges
        };
        let options = {
            physics: {
                barnesHut: {
                    damping: 0.5,
                    springLength: 150,
                },
            },
        };
        network = new vis.Network(container, data, options);
        network.on("stabilizationProgress", function(params) {
            let p = Math.trunc((params.iterations/params.total * 100.0)) + "%";
            $("#progress-bar").width(p);
        });
        network.once("stabilizationIterationsDone", function() {
            $("#progress").hide();
        });
    }

    function set_streams(streams) {
        let preselected = window.location.hash
        if (!preselected) {
            preselected = DEFAULT_STREAM;
        } else {
            preselected = preselected.substring(1);
        }

        let s = $("#streams");
        s.empty();
        streams.forEach(function(stream){
            let opt = $("<option></option>")
                .attr("value", stream)
                .text(stream);
            if (preselected === stream) {
                opt.prop("selected", true);
                load(stream);
            }
            s.append(opt);
        });
    }

    function update_streams() {
        $.ajax({
            url: "streams.json",
            type: "GET"
        })
            .done(function(data){
                set_streams(data);
            })
            .fail(function(r, e, ex){
                failure("Failed to refresh streams: " + ex);
            });
    }

    function load(stream) {

        window.location.hash = "#" + stream;
        $("#progress-bar").width("0%");
        $("#progress").show();

        $.ajax({
            url: "streams/" + stream + ".json",
            accepts: {
                json: "application/json",
            },
            type: "GET",
            dataType: "json",
        })
            .done(function(data){

                try {

                    let nodes = [];
                    let edges = [];

                    for (let i = 0; i < data.nodes.length; i++) {
                        let node = data.nodes[i];
                        nodes.push({
                            id: "" + i,
                            label: node.version,
                            color: {
                                background: "#CCCCCC",
                                border: "#BBBBBB",
                            }
                        });
                    }

                    for (let i = 0; i < data.edges.length; i++) {
                        let path = data.edges[i];
                        let from = "" + path[0]
                        let to = "" + path[1];
                        edges.push({
                            from: from,
                            to: to,
                            id: from + "-" + to,
                            arrows: {to: {enabled: true, scaleFactor: 0.5}},
                            color: {color: "#DDDDDD"},
                            chosen: {
                                edge: function (values, id, selected, hovering) {
                                    let node_id = network.getSelection().nodes[0];
                                    console.log(node_id, id);
                                    if (id.startsWith(node_id + "-")) {
                                        values.color = "#7bc084";
                                    } else {
                                        values.color = "#efdf29";
                                        values.dashes = true;
                                    }
                                    values.width = 3;
                                }
                            }
                        });
                    }

                    // console.log("Update", "nodes", nodes, "edges", edges);

                    update_data(new vis.DataSet(nodes), new vis.DataSet(edges));
                }
                catch (e) {
                    failure("Failed to process result: " + e)
                }
            })
        .fail(function(r, e, ex){
            failure("Failed to update graph: " + ex);
            $("#progress").hide();
        });

    }

    $("#streams").change(function(){
        $("#streams option:selected").each(function(){
            let s = $(this).attr("value");
            load(s);
        });
    });
    update_streams();

</script>

</body>
</html>